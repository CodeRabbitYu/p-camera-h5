/*!
* p-camera-h5 v1.0.0-beta.1
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-21 22:03:26
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).pCameraH5=e()}(this,(function(){"use strict";function t(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)}function e(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n}"function"==typeof SuppressedError&&SuppressedError;var n,i,r,a,o,s,h,d,c,l,f,p,m,u,w,g,v,b,y,x,k,E,W,M="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 100px;\r\n  text-align: center;\r\n  font-size: 20px;\r\n  z-index: 200;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-watermark {\r\n  position: absolute;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 10px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 10px;\r\n  left: 0;\r\n  color: white;\r\n  font-size: 20px;\r\n  text-align: center;\r\n}\r\n";!function(t,e){void 0===e&&(e={});var n=e.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t))}}(M);return i=new WeakMap,r=new WeakMap,a=new WeakMap,o=new WeakMap,s=new WeakMap,h=new WeakMap,d=new WeakMap,c=new WeakMap,l=new WeakMap,f=new WeakMap,p=new WeakMap,m=new WeakMap,u=new WeakMap,w=new WeakMap,g=new WeakMap,n=new WeakSet,v=function(){t(this,i,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n';const e=document.createElement("style");e.innerHTML=Object.values(M).join(""),t(this,i,"f").el.appendChild(e)},b=function(){if(e(this,h,document.getElementById("p-watermark-btn"),"f"),e(this,d,document.getElementById("p-capture-btn"),"f"),e(this,c,document.getElementById("p-record-btn"),"f"),!t(this,d,"f")||!t(this,c,"f"))throw new Error("Buttons not initialized");t(this,h,"f").addEventListener("click",(()=>this.toggleWatermark())),t(this,d,"f").addEventListener("click",(()=>this.handleCapture())),t(this,c,"f").addEventListener("click",(()=>this.handleRecording()))},y=async function(){try{e(this,s,document.getElementById("p-video"),"f");const i=document.getElementById("p-canvas");e(this,r,await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),"f"),e(this,m,i.getContext("2d"),"f"),e(this,u,t(this,n,"m",x).call(this),"f"),t(this,s,"f").srcObject=t(this,u,"f")}catch(t){throw new Error("Error accessing media devices: "+t.message)}},x=function(){if(!t(this,m,"f")||!t(this,r,"f"))throw new Error("初始化失败");if(!t(this,s,"f"))throw new Error("video is required");const e=document.getElementById("p-canvas");e.width=t(this,s,"f").clientWidth,e.height=t(this,s,"f").clientHeight;const i=e.captureStream(30),a=t(this,r,"f").getAudioTracks();a.length>0&&i.addTrack(a[0]);const o=document.createElement("video");return o.srcObject=new MediaStream(t(this,r,"f").getVideoTracks()),o.onloadedmetadata=()=>{o.play(),t(this,n,"m",k).call(this,o)},i},k=function i(r){if(!t(this,m,"f")||!t(this,s,"f"))return;const a=Math.max(t(this,s,"f").clientWidth/r.videoWidth,t(this,s,"f").clientHeight/r.videoHeight),o=r.videoWidth*a,h=r.videoHeight*a,d=(t(this,s,"f").clientWidth-o)/2,c=(t(this,s,"f").clientHeight-h)/2;t(this,m,"f").drawImage(r,d,c,o,h),t(this,n,"m",E).call(this,t(this,m,"f")),e(this,w,requestAnimationFrame((()=>t(this,n,"m",i).call(this,r))),"f")},E=function(e){if(!t(this,g,"f"))return;const[n,r]=t(this,i,"f").watermark.position.split("-");let a=10,o=10;"right"===r&&(a=e.canvas.width-200),"bottom"===n&&(o=e.canvas.height-30),t(this,i,"f").watermark.text?(e.fillStyle=t(this,i,"f").watermark.color,e.font=`${t(this,i,"f").watermark.fontSize} sans-serif`,e.fillText(t(this,i,"f").watermark.text,a,o)):t(this,f,"f")&&e.drawImage(t(this,f,"f"),a,o,100,30)},W=function(t,e){const n="png"===e?"png":"mp4",i=document.createElement("a");i.href=t,i.download=`recording-${Date.now()}.${n}`,document.body.appendChild(i),i.click(),document.body.removeChild(i)},class{constructor(v){if(n.add(this),i.set(this,void 0),r.set(this,void 0),a.set(this,void 0),o.set(this,void 0),s.set(this,void 0),h.set(this,void 0),d.set(this,void 0),c.set(this,void 0),l.set(this,void 0),f.set(this,void 0),p.set(this,void 0),m.set(this,void 0),u.set(this,void 0),w.set(this,void 0),g.set(this,!0),e(this,i,{el:document.body,watermark:{text:"",image:"",position:"bottom-right",color:"rgba(255, 255, 255, 0.5)",fontSize:"20px"}},"f"),!v.el)throw new Error("el is required");Object.assign(t(this,i,"f"),v),e(this,r,null,"f"),e(this,a,null,"f"),e(this,o,[],"f"),e(this,s,null,"f"),e(this,h,null,"f"),e(this,d,null,"f"),e(this,c,null,"f"),e(this,l,null,"f"),e(this,f,null,"f"),e(this,p,null,"f"),e(this,m,null,"f"),e(this,u,null,"f"),e(this,w,null,"f"),e(this,g,!0,"f"),this.init()}async init(){t(this,n,"m",v).call(this),t(this,n,"m",b).call(this),await t(this,n,"m",y).call(this),e(this,p,document.getElementById("p-loading"),"f"),t(this,p,"f").style.display="none"}capture(){if(!t(this,m,"f"))throw new Error("Canvas未初始化");const e=document.createElement("canvas");e.width=t(this,s,"f").videoWidth,e.height=t(this,s,"f").videoHeight;return e.getContext("2d").drawImage(t(this,m,"f").canvas,0,0),e.toDataURL("image/png")}startRecording(){e(this,o,[],"f"),e(this,a,new MediaRecorder(t(this,u,"f")),"f"),t(this,a,"f").ondataavailable=e=>e.data.size>0&&t(this,o,"f").push(e.data),t(this,a,"f").start();const n=document.getElementById("p-record-time");n.style.display="inline";let i=0;e(this,l,window.setInterval((()=>{i++,n.textContent=`${Math.floor(i/60).toString().padStart(2,"0")}:${(i%60).toString().padStart(2,"0")}`}),1e3),"f")}async stopRecording(){return new Promise((e=>{t(this,a,"f").onstop=()=>{const n=new Blob(t(this,o,"f"),{type:"video/webm"});e(URL.createObjectURL(n)),clearInterval(t(this,l,"f")),document.getElementById("p-record-time").style.display="none"},t(this,a,"f")?.stop()}))}toggleWatermark(){t(this,h,"f")&&(e(this,g,!t(this,g,"f"),"f"),t(this,h,"f").textContent=t(this,g,"f")?"关闭水印":"打开水印")}handleCapture(){t(this,n,"m",W).call(this,this.capture(),"png")}async handleRecording(){if("录制"===t(this,c,"f")?.textContent)this.startRecording(),t(this,c,"f").textContent="停止";else{const e=await this.stopRecording();t(this,n,"m",W).call(this,e,"webm"),t(this,c,"f").textContent="录制"}}destroy(){t(this,w,"f")&&cancelAnimationFrame(t(this,w,"f")),t(this,r,"f")?.getTracks().forEach((t=>t.stop())),t(this,i,"f").el.innerHTML=""}}}));

/*!
* p-camera-h5 v1.0.0-beta.1
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-21 11:14:08
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).pCameraH5=e()}(this,(function(){"use strict";function t(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function e(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;var i,n,r,o,s,a,d,h,c,f="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  display: flex;\r\n  flex-direction: column;\r\n}\r\n#p-camera-h5 .top {\r\n  height: 60px;\r\n  width: 100%;\r\n}\r\n#p-camera-h5 .center {\r\n  width: 100%;\r\n  height: calc(100% - 60px - 120px);\r\n  position: relative;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-watermark {\r\n  position: absolute;\r\n}\r\n#p-camera-h5 .bottom {\r\n  height: 120px;\r\n  width: 100%;\r\n  display: flex;\r\n  align-items: center;\r\n}\r\n#p-camera-h5 .bottom .bleft,\r\n#p-camera-h5 .bottom .bright {\r\n  width: calc((100% - 200px) / 2);\r\n  height: 100%;\r\n}\r\n#p-camera-h5 .bottom .bcenter {\r\n  width: 200px;\r\n  height: 100%;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  margin: 0 10px;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n";!function(t,e){void 0===e&&(e={});var i=e.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===i&&n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r),r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t))}}(f);return i=new WeakMap,n=new WeakMap,r=new WeakMap,o=new WeakMap,s=new WeakMap,a=new WeakMap,d=new WeakMap,h=new WeakMap,c=new WeakMap,class{constructor(f){if(i.set(this,void 0),n.set(this,void 0),r.set(this,void 0),o.set(this,void 0),s.set(this,void 0),a.set(this,void 0),d.set(this,void 0),h.set(this,void 0),c.set(this,void 0),e(this,i,{el:document.body,watermark:{text:"",image:"",position:"bottom-right",color:"rgba(255, 255, 255, 0.5)",fontSize:"20px"}},"f"),!f.el)throw new Error("el is required");Object.assign(t(this,i,"f"),f),e(this,n,null,"f"),e(this,r,null,"f"),e(this,o,[],"f"),e(this,s,null,"f"),e(this,a,null,"f"),e(this,d,null,"f"),e(this,h,null,"f"),e(this,c,null,"f"),this.init()}async init(){this.setupUI(),this.setupBtns(),await this.setupCamera(),this.setupWatermark()}setupUI(){t(this,i,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div class="top">\n      <div class="tleft">\n      </div>\n      <div class="tcenter">\n      </div>\n      <div class="tright">\n        <button id="p-watermark-btn">关闭水印</button>\n      </div>\n    </div>\n    <div class="center">\n      <video id="p-video" autoplay playsinline></video>\n      <div id="p-watermark"></div>\n    </div>\n    <div class="bottom">\n      <div class="bleft">\n      </div>\n      <div class="bcenter">\n        <button id="p-capture-btn">拍照</button>\n        <button id="p-record-btn">录制</button>\n      </div>\n      <div class="bright">\n      </div>\n    </div>\n  </div>\n';const e=document.createElement("style");e.innerHTML=JSON.stringify(f),t(this,i,"f").el.appendChild(e)}setupBtns(){if(e(this,d,document.getElementById("p-watermark-btn"),"f"),e(this,h,document.getElementById("p-capture-btn"),"f"),e(this,c,document.getElementById("p-record-btn"),"f"),!t(this,h,"f")||!t(this,c,"f"))throw new Error("captureBtn or recordBtn is not initialized");if(!t(this,d,"f"))throw new Error("watermarkBtn is not initialized");t(this,d,"f").addEventListener("click",(()=>{t(this,a,"f")&&t(this,d,"f")&&(t(this,a,"f").style.display="none"===t(this,a,"f").style.display?"block":"none",t(this,d,"f").textContent="none"===t(this,a,"f").style.display?"打开水印":"关闭水印")})),t(this,h,"f").addEventListener("click",(()=>{this.downloadRecording(this.capture(),"png")})),t(this,c,"f").addEventListener("click",(()=>{t(this,c,"f")&&("录制"===t(this,c,"f").textContent?(this.startRecording(),t(this,c,"f").textContent="停止"):(this.stopRecording().then((t=>{this.downloadRecording(t,"mp4")})),t(this,c,"f").textContent="录制"))}))}async setupCamera(){try{e(this,s,document.getElementById("p-video"),"f"),e(this,n,await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),"f"),t(this,s,"f").srcObject=t(this,n,"f")}catch(t){throw new Error("Error accessing media devices: "+t.message)}}setupWatermark(){if(!t(this,i,"f").watermark.text&&!t(this,i,"f").watermark.image)throw new Error("watermark text or image is required");if(e(this,a,document.getElementById("p-watermark"),"f"),!t(this,a,"f"))throw new Error("watermark is not initialized");Object.assign(t(this,a,"f").style,{position:"absolute",pointerEvents:"none",color:t(this,i,"f").watermark.color,fontSize:t(this,i,"f").watermark.fontSize});if(t(this,i,"f").watermark.position.split("-").forEach((e=>{t(this,a,"f")&&(t(this,a,"f").style[e]="10px")})),t(this,i,"f").watermark.text)t(this,a,"f").textContent=t(this,i,"f").watermark.text;else if(t(this,i,"f").watermark.image){const e=new Image;e.src=t(this,i,"f").watermark.image,t(this,a,"f").appendChild(e)}}capture(){if(!t(this,s,"f"))throw new Error("video is not initialized");const e=document.createElement("canvas");e.width=t(this,s,"f").videoWidth,e.height=t(this,s,"f").videoHeight;return e.getContext("2d").drawImage(t(this,s,"f"),0,0),e.toDataURL("image/png")}startRecording(){e(this,o,[],"f");if(!t(this,n,"f"))throw new Error("mediaStream is not initialized");e(this,r,new MediaRecorder(t(this,n,"f"),{mimeType:"video/webm"}),"f"),t(this,r,"f").ondataavailable=e=>{e.data.size>0&&t(this,o,"f").push(e.data)},t(this,r,"f").start()}stopRecording(){return new Promise((e=>{if(!t(this,r,"f"))throw new Error("mediaRecorder is not initialized");t(this,r,"f").onstop=()=>{const i=new Blob(t(this,o,"f"),{type:"video/webm"});e(URL.createObjectURL(i))},t(this,r,"f").stop()}))}downloadRecording(t,e){const i=document.createElement("a");i.href=t,"mp4"==e?i.download=`recording-${Date.now()}.mp4`:"webm"==e?i.download=`recording-${Date.now()}.webm`:"png"==e&&(i.download=`recording-${Date.now()}.png`),document.body.appendChild(i),i.click(),document.body.removeChild(i)}destroy(){if(!t(this,s,"f"))throw new Error("video is not initialized");if(!t(this,n,"f"))throw new Error("mediaStream is not initialized");t(this,n,"f").getTracks().forEach((t=>t.stop())),t(this,i,"f").el.removeChild(t(this,s,"f")),t(this,a,"f")&&t(this,i,"f").el.removeChild(t(this,a,"f"))}}}));

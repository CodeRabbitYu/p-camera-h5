/*!
* p-camera-h5 v1.0.0-beta.1
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-21 22:03:26
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).pCameraH5=e()}(this,(function(){"use strict";function t(t,e,i,n){if("a"===i&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!n:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?n:"a"===i?n.call(t):n?n.value:e.get(t)}function e(t,e,i,n,r){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?r.call(t,i):r?r.value=i:e.set(t,i),i}"function"==typeof SuppressedError&&SuppressedError;var i,n,r,o,a,s,h,d,c,l,f,p,m,u,w,v,g,b,x,y,k,E,W,M="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 100px;\r\n  text-align: center;\r\n  font-size: 20px;\r\n  z-index: 200;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-canvas {\r\n  width: 100%;\r\n  height: 100%;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 10px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 10px;\r\n  left: 0;\r\n  color: white;\r\n  font-size: 20px;\r\n  text-align: center;\r\n}\r\n";!function(t,e){void 0===e&&(e={});var i=e.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===i&&n.firstChild?n.insertBefore(r,n.firstChild):n.appendChild(r),r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t))}}(M);return n=new WeakMap,r=new WeakMap,o=new WeakMap,a=new WeakMap,s=new WeakMap,h=new WeakMap,d=new WeakMap,c=new WeakMap,l=new WeakMap,f=new WeakMap,p=new WeakMap,m=new WeakMap,u=new WeakMap,w=new WeakMap,v=new WeakMap,i=new WeakSet,g=function(){t(this,n,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n';const e=document.createElement("style");e.innerHTML=Object.values(M).join(""),t(this,n,"f").el.appendChild(e)},b=function(){if(e(this,h,document.getElementById("p-watermark-btn"),"f"),e(this,d,document.getElementById("p-capture-btn"),"f"),e(this,c,document.getElementById("p-record-btn"),"f"),!t(this,d,"f")||!t(this,c,"f"))throw new Error("Buttons not initialized");t(this,h,"f").addEventListener("click",(()=>this.toggleWatermark())),t(this,d,"f").addEventListener("click",(()=>this.handleCapture())),t(this,c,"f").addEventListener("click",(()=>this.handleRecording()))},x=async function(){try{e(this,s,document.getElementById("p-video"),"f");const n=document.getElementById("p-canvas");e(this,r,await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),"f"),e(this,m,n.getContext("2d"),"f"),e(this,u,t(this,i,"m",y).call(this),"f"),t(this,s,"f").srcObject=t(this,u,"f")}catch(t){throw new Error("Error accessing media devices: "+t.message)}},y=function(){if(!t(this,m,"f")||!t(this,r,"f"))throw new Error("初始化失败");if(!t(this,s,"f"))throw new Error("video is required");const e=document.getElementById("p-canvas");e.width=t(this,s,"f").clientWidth,e.height=t(this,s,"f").clientHeight;const n=e.captureStream(30),o=t(this,r,"f").getAudioTracks();o.length>0&&n.addTrack(o[0]);const a=document.createElement("video");return a.srcObject=new MediaStream(t(this,r,"f").getVideoTracks()),a.onloadedmetadata=()=>{a.play(),t(this,i,"m",k).call(this,a)},n},k=function n(r){if(!t(this,m,"f")||!t(this,s,"f"))return;const o=Math.max(t(this,s,"f").clientWidth/r.videoWidth,t(this,s,"f").clientHeight/r.videoHeight),a=r.videoWidth*o,h=r.videoHeight*o,d=(t(this,s,"f").clientWidth-a)/2,c=(t(this,s,"f").clientHeight-h)/2;t(this,m,"f").drawImage(r,d,c,a,h),t(this,i,"m",E).call(this,t(this,m,"f")),e(this,w,requestAnimationFrame((()=>t(this,i,"m",n).call(this,r))),"f")},E=function(e){if(!t(this,v,"f"))return;const[i,r]=t(this,n,"f").watermark.position.split("-");let o=10,a=10;"right"===r&&(o=e.canvas.width-100),"bottom"===i&&(a=e.canvas.height-10),t(this,n,"f").watermark.text&&(e.fillStyle=t(this,n,"f").watermark.color,e.font=`${t(this,n,"f").watermark.fontSize} sans-serif`,e.fillText(t(this,n,"f").watermark.text,o,a))},W=function(t,e){const i="png"===e?"png":"mp4",n=document.createElement("a");n.href=t,n.download=`recording-${Date.now()}.${i}`,document.body.appendChild(n),n.click(),document.body.removeChild(n)},class{constructor(g){if(i.add(this),n.set(this,void 0),r.set(this,void 0),o.set(this,void 0),a.set(this,void 0),s.set(this,void 0),h.set(this,void 0),d.set(this,void 0),c.set(this,void 0),l.set(this,void 0),f.set(this,void 0),p.set(this,void 0),m.set(this,void 0),u.set(this,void 0),w.set(this,void 0),v.set(this,!0),e(this,n,{el:document.body,watermark:{text:"",image:"",position:"bottom-right",color:"rgba(255, 255, 255, 0.5)",fontSize:"20px"}},"f"),!g.el)throw new Error("el is required");Object.assign(t(this,n,"f"),g),e(this,r,null,"f"),e(this,o,null,"f"),e(this,a,[],"f"),e(this,s,null,"f"),e(this,h,null,"f"),e(this,d,null,"f"),e(this,c,null,"f"),e(this,l,null,"f"),e(this,p,null,"f"),e(this,f,null,"f"),e(this,m,null,"f"),e(this,u,null,"f"),e(this,w,null,"f"),e(this,v,!0,"f"),this.init()}async init(){t(this,i,"m",g).call(this),t(this,i,"m",b).call(this),await t(this,i,"m",x).call(this),e(this,f,document.getElementById("p-loading"),"f"),t(this,f,"f").style.display="none"}capture(){if(!t(this,m,"f"))throw new Error("Canvas未初始化");const e=document.createElement("canvas");e.width=t(this,s,"f").videoWidth,e.height=t(this,s,"f").videoHeight;return e.getContext("2d").drawImage(t(this,m,"f").canvas,0,0),e.toDataURL("image/png")}startRecording(){e(this,a,[],"f"),e(this,o,new MediaRecorder(t(this,u,"f")),"f"),t(this,o,"f").ondataavailable=e=>e.data.size>0&&t(this,a,"f").push(e.data),t(this,o,"f").start(),e(this,p,document.getElementById("p-record-time"),"f"),t(this,p,"f").style.display="inline";let i=0;e(this,l,window.setInterval((()=>{if(i++,!t(this,p,"f"))throw new Error("recordTime is required");i>=60&&(clearInterval(t(this,l,"f")),t(this,p,"f").textContent="00:00"),t(this,p,"f").textContent=`${Math.floor(i/60).toString().padStart(2,"0")}:${(i%60).toString().padStart(2,"0")}`}),1e3),"f")}async stopRecording(){return new Promise((e=>{t(this,o,"f").onstop=()=>{const i=new Blob(t(this,a,"f"),{type:"video/webm"});if(e(URL.createObjectURL(i)),!t(this,p,"f")||!t(this,l,"f"))throw new Error("recordTime is required");clearInterval(t(this,l,"f")),t(this,p,"f").textContent="00:00"},t(this,o,"f")?.stop()}))}toggleWatermark(){t(this,h,"f")&&(e(this,v,!t(this,v,"f"),"f"),t(this,h,"f").textContent=t(this,v,"f")?"关闭水印":"打开水印")}handleCapture(){t(this,i,"m",W).call(this,this.capture(),"png")}async handleRecording(){if("录制"===t(this,c,"f")?.textContent)this.startRecording(),t(this,c,"f").textContent="停止";else{const e=await this.stopRecording();t(this,i,"m",W).call(this,e,"webm"),t(this,c,"f").textContent="录制"}}destroy(){t(this,w,"f")&&cancelAnimationFrame(t(this,w,"f")),t(this,r,"f")?.getTracks().forEach((t=>t.stop())),t(this,n,"f").el.innerHTML=""}}}));

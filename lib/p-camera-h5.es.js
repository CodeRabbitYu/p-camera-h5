/*!
* p-camera-h5 v1.0.0-beta.1
* Copyright 2024 Pbstar (https://github.com/pbstar)
* Licensed under MIT (https://github.com/pbstar/p-camera-h5/blob/main/LICENSE)
* 2025-02-21 11:14:08
*/
function t(t,e,n,i){if("a"===n&&!i)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!i:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?i:"a"===n?i.call(t):i?i.value:e.get(t)}function e(t,e,n,i,r){if("m"===i)throw new TypeError("Private method is not writable");if("a"===i&&!r)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!r:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===i?r.call(t,n):r?r.value=n:e.set(t,n),n}"function"==typeof SuppressedError&&SuppressedError;var n,i,r,a,o,s,d,h,l,c,p,f,m,u,w,g,v,y,b="#p-camera-h5 {\r\n  width: 100%;\r\n  height: 100%;\r\n  background-color: #000;\r\n  position: relative;\r\n}\r\n#p-camera-h5 div {\r\n  box-sizing: border-box;\r\n}\r\n#p-camera-h5 #p-loading {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  background-color: #000;\r\n  color: #fff;\r\n  line-height: 100px;\r\n  text-align: center;\r\n  font-size: 20px;\r\n  z-index: 200;\r\n}\r\n\r\n#p-camera-h5 #p-container {\r\n  width: 100%;\r\n  height: calc(100% - 150px);\r\n  position: absolute;\r\n  top: 50px;\r\n  left: 0;\r\n}\r\n#p-camera-h5 #p-video {\r\n  width: 100%;\r\n  height: 100%;\r\n  position: absolute;\r\n  top: 0;\r\n  left: 0;\r\n  object-fit: cover;\r\n}\r\n#p-camera-h5 #p-watermark {\r\n  position: absolute;\r\n}\r\n#p-camera-h5 #p-capture-btn,\r\n#p-camera-h5 #p-record-btn {\r\n  width: 80px;\r\n  height: 40px;\r\n  line-height: 40px;\r\n  text-align: center;\r\n  border-radius: 10px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n}\r\n#p-camera-h5 #p-capture-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% - 90px);\r\n}\r\n#p-camera-h5 #p-record-btn {\r\n  position: absolute;\r\n  bottom: 30px;\r\n  left: calc(50% + 10px);\r\n}\r\n#p-camera-h5 #p-watermark-btn {\r\n  position: absolute;\r\n  top: 10px;\r\n  right: 10px;\r\n  z-index: 100;\r\n  width: 60px;\r\n  height: 20px;\r\n  line-height: 20px;\r\n  text-align: center;\r\n  border-radius: 5px;\r\n  border: none;\r\n  outline: none;\r\n  cursor: pointer;\r\n  background-color: #fff;\r\n  font-size: 12px;\r\n}\r\n#p-camera-h5 #p-record-time {\r\n  width: 100%;\r\n  position: absolute;\r\n  top: 10px;\r\n  left: 0;\r\n  color: white;\r\n  font-size: 20px;\r\n  text-align: center;\r\n}\r\n";!function(t,e){void 0===e&&(e={});var n=e.insertAt;if("undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t))}}(b);class x{constructor(u){if(n.add(this),i.set(this,void 0),r.set(this,void 0),a.set(this,void 0),o.set(this,void 0),s.set(this,void 0),d.set(this,void 0),h.set(this,void 0),l.set(this,void 0),c.set(this,void 0),p.set(this,void 0),f.set(this,void 0),m.set(this,void 0),e(this,i,{el:document.body,watermark:{text:"",image:"",position:"bottom-right",color:"rgba(255, 255, 255, 0.5)",fontSize:"20px"}},"f"),!u.el)throw new Error("el is required");Object.assign(t(this,i,"f"),u),e(this,r,null,"f"),e(this,a,null,"f"),e(this,o,[],"f"),e(this,s,null,"f"),e(this,d,null,"f"),e(this,h,null,"f"),e(this,l,null,"f"),e(this,c,null,"f"),e(this,p,null,"f"),e(this,f,null,"f"),e(this,m,null,"f"),this.init()}async init(){t(this,n,"m",u).call(this),t(this,n,"m",w).call(this),await t(this,n,"m",g).call(this),t(this,n,"m",v).call(this),e(this,m,document.getElementById("p-loading"),"f"),t(this,m,"f").style.display="none"}capture(){if(!t(this,s,"f"))throw new Error("Video not initialized");const e=document.createElement("canvas");e.width=t(this,s,"f").videoWidth,e.height=t(this,s,"f").videoHeight;const n=e.getContext("2d");if(n?.drawImage(t(this,s,"f"),0,0),"none"!==t(this,d,"f")?.style.display){n.fillStyle=t(this,i,"f").watermark.color,n.font=`${t(this,i,"f").watermark.fontSize} sans-serif`;const[r,a]=t(this,i,"f").watermark.position.split("-"),o="left"===a?10:e.width-10-n.measureText(t(this,i,"f").watermark.text).width,s="top"===r?30:e.height-10;t(this,i,"f").watermark.text?n.fillText(t(this,i,"f").watermark.text,o,s):t(this,f,"f")&&n.drawImage(t(this,f,"f"),o,s)}return e.toDataURL("image/png")}startRecording(){e(this,o,[],"f"),e(this,a,new MediaRecorder(t(this,r,"f")),"f"),t(this,a,"f").ondataavailable=e=>e.data.size>0&&t(this,o,"f").push(e.data),t(this,a,"f").start();const n=document.getElementById("p-record-time");n.style.display="inline";let i=0;e(this,p,window.setInterval((()=>{i++,n.textContent=`${Math.floor(i/60).toString().padStart(2,"0")}:${(i%60).toString().padStart(2,"0")}`}),1e3),"f")}async stopRecording(){return new Promise((e=>{t(this,a,"f").onstop=()=>{const n=new Blob(t(this,o,"f"),{type:"video/webm"});e(URL.createObjectURL(n)),clearInterval(t(this,p,"f")),document.getElementById("p-record-time").style.display="none"},t(this,a,"f")?.stop()}))}toggleWatermark(){if(!t(this,d,"f")||!t(this,h,"f"))return;const e="none"===t(this,d,"f").style.display;t(this,d,"f").style.display=e?"block":"none",t(this,h,"f").textContent=e?"关闭水印":"打开水印"}handleCapture(){t(this,n,"m",y).call(this,this.capture(),"png")}async handleRecording(){if("录制"===t(this,c,"f")?.textContent)this.startRecording(),t(this,c,"f").textContent="停止";else{const e=await this.stopRecording();t(this,n,"m",y).call(this,e,"webm"),t(this,c,"f").textContent="录制"}}destroy(){t(this,r,"f")?.getTracks().forEach((t=>t.stop())),t(this,i,"f").el.innerHTML=""}}i=new WeakMap,r=new WeakMap,a=new WeakMap,o=new WeakMap,s=new WeakMap,d=new WeakMap,h=new WeakMap,l=new WeakMap,c=new WeakMap,p=new WeakMap,f=new WeakMap,m=new WeakMap,n=new WeakSet,u=function(){t(this,i,"f").el.innerHTML='\n  <div id="p-camera-h5">\n    <div id="p-loading">加载中...</div>\n    <div id="p-error"></div>\n    <div id="p-container">\n      <video id="p-video" autoplay playsinline></video>\n      <canvas id="p-canvas" style="display:none;"></canvas>\n      <div id="p-watermark"></div>\n    </div>\n    <div id="p-watermark-btn">关闭水印</div>\n    <div id="p-capture-btn">拍照</div>\n    <div id="p-record-btn">录制</div>\n    <div id="p-record-time">00:00</div>\n  </div>\n';const e=document.createElement("style");e.innerHTML=JSON.stringify(b),t(this,i,"f").el.appendChild(e)},w=function(){if(e(this,h,document.getElementById("p-watermark-btn"),"f"),e(this,l,document.getElementById("p-capture-btn"),"f"),e(this,c,document.getElementById("p-record-btn"),"f"),!t(this,l,"f")||!t(this,c,"f"))throw new Error("Buttons not initialized");t(this,h,"f").addEventListener("click",(()=>this.toggleWatermark())),t(this,l,"f").addEventListener("click",(()=>this.handleCapture())),t(this,c,"f").addEventListener("click",(()=>this.handleRecording()))},g=async function(){try{e(this,s,document.getElementById("p-video"),"f"),e(this,r,await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),"f"),t(this,s,"f").srcObject=t(this,r,"f")}catch(t){throw new Error("Error accessing media devices: "+t.message)}},v=function(){if(!t(this,i,"f").watermark.text&&!t(this,i,"f").watermark.image)throw new Error("Watermark content required");e(this,d,document.getElementById("p-watermark"),"f"),Object.assign(t(this,d,"f").style,{position:"absolute",pointerEvents:"none",color:t(this,i,"f").watermark.color,fontSize:t(this,i,"f").watermark.fontSize});const[n,r]=t(this,i,"f").watermark.position.split("-");t(this,d,"f").style[n]="10px",t(this,d,"f").style[r]="10px",t(this,i,"f").watermark.text?t(this,d,"f").textContent=t(this,i,"f").watermark.text:(e(this,f,new Image,"f"),t(this,f,"f").src=t(this,i,"f").watermark.image,t(this,d,"f").appendChild(t(this,f,"f")))},y=function(t,e){const n="png"===e?"png":"mp4",i=document.createElement("a");i.href=t,i.download=`recording-${Date.now()}.${n}`,document.body.appendChild(i),i.click(),document.body.removeChild(i)};export{x as default};
